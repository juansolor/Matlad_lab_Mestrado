% BCS SYM
clear
clc
syms g Cc A1 A2 D1 D2 h1 hw L1 L2 V1 V2 f0 q0_dt q0_ut Inp Pnp b1 b2 M rho PI mu dfq_max dzc_max tp1 tp2 CH Cq Cp y y2 pr drho dPI dmu 
%g   = 9.81;   % Gravitational acceleration constant [m/s²]
% Cc = 2e-5 ;   % Choke valve constant
% A1 = 0.008107;% Cross-section area of pipe below ESP [m²]
% A2 = 0.008107;% Cross-section area of pipe above ESP [m²]
% D1 = 0.1016;  % Pipe diameter below ESP [m]
% D2 = 0.1016;  % Pipe diameter above ESP [m]
% h1 = 200;     % Heigth from reservoir to ESP [m]
% hw = 1000;    % Total vertical distance in well [m]
% L1 =  500;    % Length from reservoir to ESP [m]
% L2 = 1200;    % Length from ESP to choke [m]
% V1 = 4.054;   % Pipe volume below ESP [m3]
% V2 = 9.729;   % Pipe volume above ESP [m3]
% f0 = 60;      % ESP characteristics reference freq [Hz]
% q0_dt = 0.00542847756833871; % Downtrhust flow at f0 m3/s
% q0_ut = 0.0134581949664923;  % Uptrhust flow at f0 m3/s
% Inp = 65;     % ESP motor nominal current [A]
% Pnp = 1.625e5;% ESP motor nominal Power [W]
% b1 = 1.5e9;   % Bulk modulus below ESP [Pa]
% b2 = 1.5e9;   % Bulk modulus above ESP [Pa]
% M  = 1.992e8; % Fluid inertia parameters [kg/m4]
% %rho_n = 950;    % Density of produced fluid [kg/mÃ?Â³]
% PI= 2.32e-9; % Well productivy index [m3/s/Pa]
%INCERTEZA mix%
rho_min =rho-drho;
rho_max =rho+drho;
PI_min = PI-dPI; 
PI_max = PI+dPI;
mu_min=mu-dmu;
mu_max=mu+dmu;
% mu  = 0.025;  % Viscosity [Pa*s]
% dfq_max = 0.5;   % máxima variação em f/s
% dzc_max = 1;   % máxima variação em zc %/s
tp1= 1/dfq_max; 
tp2=1/dzc_max;  % Actuator Response time
CH = -0.03*mu + 1;
Cq = 2.7944*mu^4 - 6.8104*mu^3 + 6.0032*mu^2 - 2.6266*mu + 1;
Cp = -4.4376*mu^4 + 11.091*mu^3 -9.9306*mu^2 + 3.9042*mu + 1;
% pr = 1.26e7; % Reservoir pressure
% pm = 2e5;%101325;%1atm fez o foco do sinal ficar mais centrado no envelope   nominal: 2e6;    % Manifold pressure

%% Symbolic pbh(t) = x(1); pwh(t) = x(2); q(t) = x(3); fq(t) = x(4); zc(t) = x(5);
syms pbh(t) pwh(t) q(t) fq(t) zc(t)
% Entradas fqref(t) = u(1); zcref(t) = u(2); pm = u(3); pr = u(4);
syms fqref(t) zcref pm pr
% SEA
% Calculo do HEAD e delta de pressão
q0 = q(t)/Cq*(f0/fq(t));
H0 = -1.2454e6*q0^2 + 7.4959e3*q0 + 9.5970e2;
H = CH*H0*(fq(t)/f0)^2;% Head
Dp = rho*g*H;% Delta de pressão
% Calculo da Potencia e corrente da bomba
P0 = -2.3599e9*q0^3 -1.8082e7*q0^2 +4.3346e6*q0 + 9.4355e4;
P = Cp*P0*(fq(t)/f0)^3; % Potencia
I = Inp*P/Pnp;       % Corrente
% Calculo da pressão de intaike
F1 = 0.158*((rho*L1*q(t)^2)/(D1*A1^2))*(mu/(rho*D1*q(t)))^(1/4);
F2 = 0.158*((rho*L2*q(t)^2)/(D2*A2^2))*(mu/(rho*D2*q(t)))^(1/4);

% Vazao do rezervatorio vazao da chocke
qr  = PI*(pr - pbh(t));
% qc  = Cc*(zc(t)/100)*sign((pwh(t) - pm))*sqrt(abs(pwh(t) - pm));%isso tem chaveamento
qc  = Cc*(zc(t)/100)*sqrt((pwh(t) - pm));

% System of nonlinear ordinary diferenctial equations
dpbhdt=diff(pbh, t) == b1/V1*(qr - q);
dpwhdt =diff(pwh,t)== b2/V2*(q(t) - qc);
dqdt = diff(q,t)== 1/M*(pbh(t) - pwh(t) - rho*g*hw - F1 - F2 + Dp);
dfqdt = diff(fq,t)==(fqref - fq(t))/tp1;
dzcdt = diff(zc,t)==(zcref - zc(t))/tp2;
dxdt = [dpbhdt;dpwhdt;dqdt;dfqdt;dzcdt];
% pbh = dsolve(dpbhdt);
% pwh = dsolve(dpwhdt);
% q = dsolve(dqdt);
% fq = dsolve(dfqdt);
% zc = dsolve(dzcdt);

%Saidas
%y = [pin,H,qc,qr,P,I,Dp]';
pin(t) = pbh(t) - rho*g*h1 - F1;
y=pin;
%% Temos Dinamica nao Contralada.
% u1=fqref, y1=Pin , x=x1,x2,x3,x4,x5, estados.
% Modelo nao Linear Xdt=f(x)+g*u
%pin=pbh(t) - g*h1*rho - (79*L1*q(t)^2*rho*(mu/(D1*q(t)*rho))^(1/4))/(500*A1^2*D1);
%pin=pbh(t) - g*h1*rho - (79*L1*q(t)^7/4*rho*(mu/(D1*rho))^(1/4))/(500*A1^2*D1);
%Pindt=diff(pbh(t), t) + (79*L1*mu*diff(q(t), t))/(2000*A1^2*D1^2*(mu/(D1*rho*q(t)))^(3/4)) - (79*L1*rho*q(t)*diff(q(t), t)*(mu/(D1*rho*q(t)))^(1/4))/(250*A1^2*D1)
Pindt=diff(pin,t);
% vpa(Pindt,4)
Pindt = subs(Pindt,lhs(dxdt),rhs(dxdt));

Pindt2 = diff(Pindt,t);

Pindt2 = subs(Pindt2,lhs(dxdt),rhs(dxdt));%PinDt2 em relação a fqref
% Pindt2=expand(Pindt2);


% Pindt2 = collect(Pindt2,fqref);
cxFQ = coeffs(Pindt2,fqref);%Pin em relação a Fq
cxFQ=cxFQ(t);

Ff = cxFQ(1,1);%Nominal
Gf = cxFQ(1,2);
%%
IN=1;
switch IN
    
    case 1 %PI
        Ftil_min= subs(Ff,PI,PI_min);%fazer min
        Ftil_max= subs(Ff,PI,PI_max);%fazer max
        F=abs(Ff-Ftil_min);%PI incer
                        
    case 2 %mu
        Ftil_min= subs(Ff,mu,mu_min);%fazer min
        Ftil_max= subs(Ff,mu,mu_max);%fazer max
        Gtil_min= subs(Gf,mu,mu_min);%fazer min
        Gtil_max= subs(Gf,mu,mu_max);%fazer max
        F=abs(Ff-Ftil_min);%mu incer
        B=(Gtil_max/Gtil_min)^(1/2);
        
    case 3 %rho
        Ftil_min= subs(Ff,rho,rho_min);%fazer min
        Ftil_max= subs(Ff,rho,rho_max);%fazer max
        Gtil_min= subs(Gf,rho,rho_min);%fazer min
        Gtil_max= subs(Gf,rho,rho_max);%fazer max
        F=abs(Ff-Ftil_min);%mu incer
        B=(Gtil_max/Gtil_min)^(1/2);
        %B=-((79*L1*mu*((g*fq(t)^2*((3*mu)/100 - 1)*(drho + rho)*((2490800*dfq_max*f0^2*q(t)^2)/(fq(t)^3*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)^2) - (74959*dfq_max*f0*q(t))/(10*fq(t)^2*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1))))/f0^2 + (2*dfq_max*g*fq(t)*((3*mu)/100 - 1)*(drho + rho)*((74959*f0*q(t))/(10*fq(t)*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)) - (1245400*f0^2*q(t)^2)/(fq(t)^2*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)^2) + 9597/10))/f0^2))/(2000*A1^2*D1^2*M*(mu/(D1*q(t)*(drho + rho)))^(3/4)) - (79*L1*q(t)*(drho + rho)*((g*fq(t)^2*((3*mu)/100 - 1)*(drho + rho)*((2490800*dfq_max*f0^2*q(t)^2)/(fq(t)^3*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)^2) - (74959*dfq_max*f0*q(t))/(10*fq(t)^2*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1))))/f0^2 + (2*dfq_max*g*fq(t)*((3*mu)/100 - 1)*(drho + rho)*((74959*f0*q(t))/(10*fq(t)*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)) - (1245400*f0^2*q(t)^2)/(fq(t)^2*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)^2) + 9597/10))/f0^2)*(mu/(D1*q(t)*(drho + rho)))^(1/4))/(250*A1^2*D1*M))/(2*((79*L1*mu*((g*fq(t)^2*((3*mu)/100 - 1)*(drho - rho)*((2490800*dfq_max*f0^2*q(t)^2)/(fq(t)^3*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)^2) - (74959*dfq_max*f0*q(t))/(10*fq(t)^2*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1))))/f0^2 + (2*dfq_max*g*fq(t)*((3*mu)/100 - 1)*(drho - rho)*((74959*f0*q(t))/(10*fq(t)*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)) - (1245400*f0^2*q(t)^2)/(fq(t)^2*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)^2) + 9597/10))/f0^2))/(2000*A1^2*D1^2*M*(-mu/(D1*q(t)*(drho - rho)))^(3/4)) + (79*L1*q(t)*((g*fq(t)^2*((3*mu)/100 - 1)*(drho - rho)*((2490800*dfq_max*f0^2*q(t)^2)/(fq(t)^3*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)^2) - (74959*dfq_max*f0*q(t))/(10*fq(t)^2*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1))))/f0^2 + (2*dfq_max*g*fq(t)*((3*mu)/100 - 1)*(drho - rho)*((74959*f0*q(t))/(10*fq(t)*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)) - (1245400*f0^2*q(t)^2)/(fq(t)^2*((3493*mu^4)/1250 - (8513*mu^3)/1250 + (3752*mu^2)/625 - (13133*mu)/5000 + 1)^2) + 9597/10))/f0^2)*(drho - rho)*(-mu/(D1*q(t)*(drho - rho)))^(1/4))/(250*A1^2*D1*M)));
        
    case 4 %TUDO
       v=[PI;mu;rho];
       v_min=[PI_min;mu_min;rho_min];
       v_max=[PI_max;mu_max;rho_max];
       Ftil_min= subs(Ff,v,v_min);%fazer min
       Ftil_max= subs(Ff,v,v_max);%fazer max
       Gtil_min= subs(Gf,v,v_min);%fazer min
       Gtil_max= subs(Gf,v,v_max);%fazer max
       F=abs(Ff-Ftil_min);%mu incer
       B=(Gtil_max/Gtil_min)^(1/2);
              
end

% logical(simplify(Ff)==simplify(Fn))
% PINDT2 = Ff+Gf*fqref;%modelo Pin em relação a Zc
% logical(simplify(Pindt2)==simplify(PINDT2))
%364.43256994430611208362470923375*rho + (727778.70976086233301436977624003*(0.0000000043092944050498986960729399406226*pbh(t) + 2.6314415834991528290594518176273*q(t) + (0.012421925769010703470839982933447*(0.000048262048192771088221458038965736*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.19789220879501723570953526731479*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) - 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/(0.25108468584284107343724891531416/(rho*q(t)))^(3/4) + 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*(0.000048262048192771088221458038965736*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.19789220879501723570953526731479*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) - 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/fq(t) - (239565.81164207061853241671925384*q(t))/fq(t) + (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 - (10184197276.158038515701508630272*q(t)*(0.000048262048192771088221458038965736*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.19789220879501723570953526731479*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) - 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/fq(t)^2) - 0.00000015479741971277030884591206665109*abs(pwh(t) - 200000.0)^(1/2)*sign(pwh(t) - 200000.0)*zc(t) + 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225) - 0.39578441759003447141907053462958*rho*q(t)*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4)*(0.000048262048192771088221458038965736*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.19789220879501723570953526731479*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) - 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)) - 0.054297109503628723570519043251845))/(0.25108468584284107343724891531416/(rho*q(t)))^(3/4) - (727778.70976086233301436977624003*(0.0000000043092944050498986960729399406226*pbh(t) + 2.6314415834991528290594518176273*q(t) + (0.012421925769010703470839982933447*(0.000049246987951807232879038815271159*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.20193082530103799562197476256611*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/(0.24606299212598425196850393700787/(rho*q(t)))^(3/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((239565.81164207061853241671925384*q(t))/fq(t) - (479131.62328414123706483343850768*(0.000049246987951807232879038815271159*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.20193082530103799562197476256611*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + (10184197276.158038515701508630272*q(t)*(0.000049246987951807232879038815271159*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.20193082530103799562197476256611*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/fq(t)^2) - 0.00000015479741971277030884591206665109*abs(pwh(t) - 200000.0)^(1/2)*sign(pwh(t) - 200000.0)*zc(t) + 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225) - 0.40386165060207599124394952513223*rho*q(t)*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4)*(0.000049246987951807232879038815271159*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.20193082530103799562197476256611*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)) - 0.054297109503628723570519043251845))/(0.24606299212598425196850393700787/(rho*q(t)))^(3/4) + 23188310.583510253047543926361814*rho*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4)*(0.000048262048192771088221458038965736*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.19789220879501723570953526731479*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) - 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225))^2 - 73221093.535403515530375630720805*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) + 74715401.566738281153444521143679*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) + (1455557.4195217246660287395524801*(0.000049246987951807232879038815271159*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.20193082530103799562197476256611*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225))^2)/(q(t)*(0.24606299212598425196850393700787/(rho*q(t)))^(3/4)) - 23661541.411745156170963190165116*rho*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4)*(0.000049246987951807232879038815271159*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.20193082530103799562197476256611*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225))^2 - (1455557.4195217246660287395524801*(0.000048262048192771088221458038965736*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.19789220879501723570953526731479*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) - 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225))^2)/(q(t)*(0.25108468584284107343724891531416/(rho*q(t)))^(3/4)) - 0.00010123126942897392002322908589827*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225) + (134309.55519700953488208103646162*(0.000049246987951807232879038815271159*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.20193082530103799562197476256611*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225))^2)/(rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(7/4)) + 23661541.411745156170963190165116*rho*q(t)*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4)*(0.0000000043092944050498986960729399406226*pbh(t) + 2.6314415834991528290594518176273*q(t) + (0.012421925769010703470839982933447*(0.000049246987951807232879038815271159*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.20193082530103799562197476256611*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/(0.24606299212598425196850393700787/(rho*q(t)))^(3/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((239565.81164207061853241671925384*q(t))/fq(t) - (479131.62328414123706483343850768*(0.000049246987951807232879038815271159*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.20193082530103799562197476256611*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + (10184197276.158038515701508630272*q(t)*(0.000049246987951807232879038815271159*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.20193082530103799562197476256611*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/fq(t)^2) - 0.00000015479741971277030884591206665109*abs(pwh(t) - 200000.0)^(1/2)*sign(pwh(t) - 200000.0)*zc(t) + 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225) - 0.40386165060207599124394952513223*rho*q(t)*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4)*(0.000049246987951807232879038815271159*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.20193082530103799562197476256611*rho*q(t)^2*(0.24606299212598425196850393700787/(rho*q(t)))^(1/4) - 0.000000000013679718875502009133066337575322*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)) - 0.054297109503628723570519043251845) - 23188310.583510253047543926361814*rho*q(t)*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4)*(0.0000000043092944050498986960729399406226*pbh(t) + 2.6314415834991528290594518176273*q(t) + (0.012421925769010703470839982933447*(0.000048262048192771088221458038965736*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.19789220879501723570953526731479*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) - 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/(0.25108468584284107343724891531416/(rho*q(t)))^(3/4) + 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*(0.000048262048192771088221458038965736*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.19789220879501723570953526731479*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) - 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/fq(t) - (239565.81164207061853241671925384*q(t))/fq(t) + (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 - (10184197276.158038515701508630272*q(t)*(0.000048262048192771088221458038965736*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.19789220879501723570953526731479*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) - 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)))/fq(t)^2) - 0.00000015479741971277030884591206665109*abs(pwh(t) - 200000.0)^(1/2)*sign(pwh(t) - 200000.0)*zc(t) + 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225) - 0.39578441759003447141907053462958*rho*q(t)*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4)*(0.000048262048192771088221458038965736*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.19789220879501723570953526731479*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) - 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225)) - 0.054297109503628723570519043251845) - (137050.56652756074987967452700165*(0.000048262048192771088221458038965736*rho - 0.00000000502008032128514096626287617443*pbh(t) + 0.00000000502008032128514096626287617443*pwh(t) + 0.19789220879501723570953526731479*rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(1/4) - 0.000000000013406124497991968950405010823815*rho*fq(t)^2*((479131.62328414123706483343850768*q(t))/fq(t) - (5092098638.0790192578507543151359*q(t)^2)/fq(t)^2 + 958.980225))^2)/(rho*q(t)^2*(0.25108468584284107343724891531416/(rho*q(t)))^(7/4))
syms ddyd(t) lambda de(t) e(t) k(t) s(t) eta
v=ddyd-lambda*2*de+lambda^2*e;
ueq=(1.0/(Gf))*(-Ftil_medio+v);
ut=ueq-k*sign(s);
%k=eta+abs(Ftilmin);
%s=de+2*lambda*e+lambda^2*;
%derivada de S
ds=(subs(Pindt2,fqref,ut)-ddyd)+2*lambda*de+lambda^2*e;
cd=ds<=-eta*sign(s);



%% modelo Pin em relação a Zc


Pindt3 = diff(Pindt2,t);
Pindt3 = subs(Pindt3,lhs(dxdt),rhs(dxdt));%PinDt2 em relação a fqref
% Pindt3 = expand(Pindt3);
% cxZC = coeffs(Pindt3,zcref);%Pin em relação a Zc
% cxZC=cxZC(t);
% 
% Fz = cxZC(1,1);
% Gz = cxZC(1,2);

% Ftil = subs(F,PI,PInominal);
PINDT3 = Fz+Gz*zcref;%modelo Pin em relação a Zc
logical(simplify(Pindt3)==simplify(PINDT3))


%projeto controlador

Ff_nominal = subs(Ff,[PI,rho],[PI_n,rho_n]);
Gf_nominal = subs(Gf,[PI,rho],[PI_n,rho_n]);


syms pinref(t) lambda K

% ztil = pin-pinref;
s = diff(ztil,t)+lambda*ztil;
% s2 = diff(s,t) == 0;
s2 = (Pindt2-diff(pinref,t,2))+lambda*(Pindt-diff(pinref,t)) == 0
% s2=subs(s2,lhs(dxdt),rhs(dxdt));

%Fchapeu!!!nominal
ueq = isolate(s2,fqref);
U = ueq-K*sgn(s);

s2u = subs(s2,fqref,U);

FBARRA = abs(subs(F,PI,PIMAX)-subs(F,PI,PInominal));


